Trick={};(function(){var trick={version:"0.5.0",versionDetail:{major:0,minor:5,patch:0}};var isOmegaTrick=true;var isSenchaTouch=Ext.TouchEventManager?true:false;var isExtCore=!isSenchaTouch&&!Ext.ComponentMgr?true:false;var isExtJS=!isSenchaTouch&&!isExtCore?true:false;Ext.apply(Ext,{isOmegaTrick:isOmegaTrick,trick:trick});Ext.applyIf(Ext,{isSenchaTouch:isSenchaTouch,isExtCore:isExtCore,isExtJS:isExtJS});Trick=Ext.trick;Ext.applyIf(Trick,{isSenchaTouch:isSenchaTouch,isExtCore:isExtCore,isExtJS:isExtJS})})();
Ext.apply(Trick,{testingFramework:{name:"yui"},removeScriptTags:function(){var me=this;Ext.select("body script").each(function(el){Ext.removeNode(Ext.getDom(el))},me)}});if(Ext.isExtCore&&!Ext.emptyFn)Ext.emptyFn=function(){};
if(!Ext.Loader)Ext.Loader=Ext.apply({},{load:function(fileList,callback,scope,preserveOrder){var scope=scope||this,head=document.getElementsByTagName("head")[0],fragment=document.createDocumentFragment(),numFiles=fileList.length,loadedFiles=0,me=this;var loadFileIndex=function(index){head.appendChild(me.buildScriptTag(fileList[index],onFileLoaded))};var onFileLoaded=function(){loadedFiles++;if(numFiles==loadedFiles&&typeof callback=="function")callback.call(scope);else if(preserveOrder===true)loadFileIndex(loadedFiles)};
if(preserveOrder===true)loadFileIndex.call(this,0);else{Ext.each(fileList,function(file,index){fragment.appendChild(this.buildScriptTag(file,onFileLoaded))},this);head.appendChild(fragment)}},buildScriptTag:function(filename,callback){var script=document.createElement("script");script.type="text/javascript";script.src=filename;if(script.readyState)script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;callback()}};else script.onload=
callback;return script}});if(Ext.isSenchaTouch&&!Function.prototype.createCallback)Ext.apply(Function.prototype,{createCallback:function(){var args=arguments,method=this;return function(){return method.apply(window,args)}}});
if((Ext.isExtCore||Ext.isSenchaTouch)&&!Function.prototype.createSequence)Ext.apply(Function.prototype,{createSequence:function(fcn,scope){var method=this;return typeof fcn!="function"?this:function(){var retval=method.apply(this||window,arguments);fcn.apply(scope||this||window,arguments);return retval}}});
Ext.applyIf(Ext,{getMaxZindex:function(){var ret=0;Ext.select("*").each(function(el){var zIndex=el.getStyle("z-index");if(Ext.isNumber(parseInt(zIndex,10))&&ret<zIndex)ret=zIndex},this);return ret},getScrollPos:function(){var y=document.documentElement.scrollTop>0?document.documentElement.scrollTop:document.body.scrollTop;var x=document.documentElement.scrollLeft>0?document.documentElement.scrollLeft:document.body.scrollLeft;return{x:x,y:y}}});if(Ext.isExtCore)Ext.Element.addMethods({getSize:function(contentSize){return{width:this.getWidth(contentSize),height:this.getHeight(contentSize)}}});if(Ext.isExtCore||Ext.isSenchaTouch)Ext.Element.addMethods({setLeftTop:function(left,top){var me=this,style=me.dom.style;style.left=me.addUnits(left);style.top=me.addUnits(top);return me},getStyles:function(){var ret={};Ext.each(arguments,function(v){ret[v]=this.getStyle(v)},this);return ret}});if(Ext.isExtCore||Ext.isSenchaTouch){Ext.util.TextMetrics=function(){var shared;return{measure:function(el,text,fixedWidth){if(!shared)shared=Ext.util.TextMetrics.Instance(el,fixedWidth);shared.bind(el);shared.setFixedWidth(fixedWidth||"auto");return shared.getSize(text)},createInstance:function(el,fixedWidth){return Ext.util.TextMetrics.Instance(el,fixedWidth)}}}();Ext.util.TextMetrics.Instance=function(bindTo,fixedWidth){var ml=new Ext.Element(document.createElement("div"));document.body.appendChild(ml.dom);
ml.position("absolute");ml.setLeftTop(-1E3,-1E3);ml.hide();if(fixedWidth)ml.setWidth(fixedWidth);var instance={getSize:function(text){ml.update(text);var s=ml.getSize();ml.update("");return s},bind:function(el){ml.setStyle(Ext.fly(el).getStyles("font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"))},setFixedWidth:function(width){ml.setWidth(width)},getWidth:function(text){ml.dom.style.width="auto";return this.getSize(text).width},getHeight:function(text){return this.getSize(text).height}};
instance.bind(bindTo);return instance};Ext.Element.addMethods({getTextWidth:function(text,min,max){return Ext.util.TextMetrics.measure(this.dom,Ext.value(text,this.dom.innerHTML,true)).width.constrain(min||0,max||1E6)}})};Ext.ns("Trick.app","Trick.form","Trick.grid","Trick.util","Trick.plugins","Trick.test","Trick.test.unit","Trick.test.case","Trick.test.case.core","Trick.test.case.touch");Trick.util.clone=function(obj){function doClone(o){if(!o||"object"!==typeof o)return o;if("function"===typeof o.clone)return o.clone();if(o.hasOwnProperty("__clonedTo"))return o.__clonedTo;var c="[object Array]"===Object.prototype.toString.call(o)?[]:{};o.__clonedTo=c;var p,v;for(p in o)if(p!=="__clonedTo"&&o.hasOwnProperty(p)){v=o[p];if(v&&"object"===typeof v)c[p]=doClone(v);else c[p]=v}return c}function finalizeClone(o){if(o.hasOwnProperty("__clonedTo")){delete o.__clonedTo;var p,v;for(p in o)if(o.hasOwnProperty(p)){v=
o[p];if(v&&"object"===typeof v)finalizeClone(v)}}}var clone=doClone(obj);finalizeClone(obj);return clone};Trick.clone=Trick.util.clone;Trick.test.unit.TestCase=function(o){var me=this,ret;switch(Trick.testingFramework.name){case "yui":ret=new YAHOO.tool.TestCase(o);ret.assert=YAHOO.util.Assert;break}return ret};Trick.test.unit.TestLogger=function(id){var me=this,ret;switch(Trick.testingFramework.name){case "yui":ret=new YAHOO.tool.TestLogger(id);break}return ret};Trick.test.unit.TestRunner=function(){var me=this,runner;return{_runner:function(){if(!runner)switch(Trick.testingFramework.name){case "yui":runner=YAHOO.tool.TestRunner;break}return runner},add:function(t){var me=this;switch(Trick.testingFramework.name){case "yui":me._runner().add(t);break}},run:function(){var me=this;switch(Trick.testingFramework.name){case "yui":me._runner().run();break}}}}();Trick.test.unit.TestSuite=function(name){var me=this,ret;switch(Trick.testingFramework.name){case "yui":ret=new YAHOO.tool.TestSuite(name);break}return ret};Trick.app.App=function(){var me=this,setupConfig={};return{setup:function(config){setupConfig=Trick.util.clone(config);config.onReady=config.onReady||Ext.emptyFn;if(Ext.isExtJS&&config.directProvider)Ext.Direct.addProvider(config.directProvider);if(Ext.isSenchaTouch)Ext.setup(config);else Ext.onReady(config.onReady,config.scope||window,config.onReadyOption);Trick.app.App.setupConfig=setupConfig}}}();Application=Trick.app.App;Trick.setup=Trick.app.App.setup;Trick.app.LoadingMaskMgr=function(){return{remove:function(o){o=o||{};var mask=Ext.get("OMEGATRICK_LOADINGMASK"),logo=Ext.get("OMEGATRICK_LOADING_LOGO"),progress=Ext.get("OMEGATRICK_LOADING_PROGRESS");if(logo)logo.fadeOut(Ext.apply(Trick.clone(o),{callback:function(){logo.remove()}}));if(progress)progress.fadeOut(Ext.apply(Trick.clone(o),{callback:function(){progress.remove();if(mask){var cb=function(){mask.remove()};if(Ext.isFunction(o.callback))cb.createSequence(o.callback);mask.fadeOut(Ext.apply(Trick.clone(o),
{callback:cb}))}}}))},setText:function(text,iconWidth){iconWidth=iconWidth||32;var wrap=Ext.get("OMEGATRICK_LOADING_PROGRESS"),to=Ext.get("OMEGATRICK_LOADING_PROGRESS_MSG"),tm=Ext.util.TextMetrics.createInstance(wrap),width=tm.getWidth(text)+iconWidth;wrap.setWidth(width);wrap.setStyle({marginLeft:"-"+width/2+"px"});to.update("<span>"+text+"</span>")},showText:function(o){var wrap=Ext.get("OMEGATRICK_LOADING_PROGRESS"),config=o||{};if(config.anim===false)wrap.show();else wrap.fadeIn(config)},hideText:function(o){var wrap=
Ext.get("OMEGATRICK_LOADING_PROGRESS"),config=o||{};if(config.anim===false)wrap.hide();else wrap.fadeOut(config)}}}();Application.LoadingMask=Trick.app.LoadingMaskMgr;Trick.app.AccountMgr=function(){var _initEvents=function(){var me=this;var o=me.config;var events={authsuccess:true,authfailure:true,signout:true};me.addEvents(events);Ext.iterate(events,function(name){if(Ext.isFunction(o[name]))me.on(name,o[name],o.scope||me)})};var _success=function(){var me=this;var lm=Application.LoadingMask;lm.remove();me.fireEvent("authsuccess")};return{msg:{text:"\u8a8d\u8a3c\u4e2d...",complete:"\u8a8d\u8a3c\u5b8c\u4e86"},init:function(o){o=o||{};var me=this;var lm=Application.LoadingMask;
Ext.applyIf(o,{dialog:Trick.SigninDialog,expDay:7,autoSigninKey:"Trick.app.AccountMgr"});me.config=Trick.clone(o);_initEvents.call(me);lm.setText(me.msg.text);o.directFn.isSignin(function(ret){if(ret){lm.setText(me.msg.complete);_success.call(me)}else{var key=Ext.util.Cookies.get(o.autoSigninKey);o.directFn.autoSignin(key,function(ret){if(ret.success)_success.call(me);else me._showDialog(o)})}})},auth:function(o){var me=this;o.directFn.auth(o.userid,o.passwd,o.autoSignin,function(ret){if(ret.success){if(o.autoSignin)Ext.util.Cookies.set(me.autoSigninKey,
ret.auto_signin_key,new Date((new Date).getTime()+me.expDay*24*60*60*1E3));me.success(ret.options)}else me.failure(ret.options)})},signout:function(){var me=this;var o=me.config;o.directFn.signout(function(){Ext.util.Cookies.set(o.autoSigninKey,null,new Date((new Date).getTime()+-1*24*60*60*1E3));me.fireEvent("signout")})},_showDialog:function(o){o=o||{};var me=this;var lm=Application.LoadingMask;var dlg=new o.dialog(o);dlg.on("auth",me.auth,dlg);dlg.on("hide",function(){_success.call(me)},me);dlg.on("failure",
function(){me.fireEvent("authfailure")},me);lm.hideText({callback:function(){dlg.show()}})}}}();Ext.apply(Trick.app.AccountMgr,new Ext.util.Observable);Application.Account=Trick.app.AccountMgr;Trick.SigninDialog=Ext.extend(Ext.Component,{initComponent:function(){var me=this;Ext.applyIf(me,{id:Ext.id(),baseCls:"tx-signin",duration:0.4,distance:100});me.layer=new Ext.Layer({id:me.id,cls:me.baseCls});Ext.apply(me,{id:Ext.id(),forms:{},bwrapCls:me.baseCls+"-bwrap",bodyCls:me.baseCls+"-body",innerCls:me.baseCls+"-inner",itemsCls:me.baseCls+"-items",itemsInnerCls:me.baseCls+"-items-inner",headerCls:me.baseCls+"-header",contentCls:me.baseCls+"-content",renderTo:me.layer});Ext.EventManager.onWindowResize(me.onWindowResize,
me);Trick.SigninDialog.superclass.initComponent.call(me)},initEvents:function(){},onRender:function(ct,position){var me=this,dh=Ext.DomHelper;Trick.SigninDialog.superclass.onRender.call(me,ct,position);var el=me.el;el.addClass(me.bwrapCls);var t=new Ext.Template('<div class="{bodyCls}">','   <div class="{innerCls}">','       <div class="clearfix">','           <div class="{headerCls}">','               <div class="title">{title}</div>',"           </div>",'           <div class="{itemsCls} clearfix">',
'               <div class="{itemsInnerCls} clearfix">','                   <div class="{contentCls}">','                       <table class="form">',"                       <tbody>","                       <tr>","                           <th>{labelUserId}</th>",'                           <td class="userid"></td>',"                       </tr>","                       <tr>","                           <th>{labelPassword}</th>",'                           <td class="passwd"></td>',"                       </tr>",
"                       <tr>","                           <th></th>",'                           <td class="msg"><span>&nbsp;</span></td>',"                       </tr>","                       <tr>","                           <th>&nbsp;</th>",'                           <td class="auto-signin"></td>',"                       </tr>","                       <tr>","                           <th>&nbsp;</th>",'                           <td class="btn-signin"></td>',"                       </tr>","                       </tbody>",
"                       </table>","                    </div>","                </div>","            </div>","        </div>","    </div>","</div>",'<div class="forget">','    <a href="{forgetUrl}">{msgForgetPass}</a>',"</div>");t.append(el,{bodyCls:me.bodyCls,innerCls:me.innerCls,itemsCls:me.itemsCls,itemsInnerCls:me.itemsInnerCls,headerCls:me.headerCls,contentCls:me.contentCls,title:Trick.SigninDialog.msg.signin.title,labelUserId:Trick.SigninDialog.msg.signin.labels.userid,labelPassword:Trick.SigninDialog.msg.signin.labels.password,
msgForgetPass:Trick.SigninDialog.msg.signin.forget.text,forgetUrl:Trick.SigninDialog.msg.signin.forget.url});me.body=Ext.get(el.child("."+me.bodyCls));me.bodyInner=Ext.get(me.body.child("."+me.innerCls));me.bodyItems=Ext.get(me.body.child("."+me.itemsCls));me.header=Ext.get(me.body.child("."+me.headerCls));me.title=Ext.get(me.header.child(".title"));me.forget=Ext.get(el.child(".forget"));me.title.setOpacity(0);me.forget.setOpacity(0);me._renderForms();this.rendered=true;me.initEvents()},_renderForms:function(){var me=
this;var useridContainer=Ext.get(me.body.child(".form .userid"));var passwdContainer=Ext.get(me.body.child(".form .passwd"));var autosigninContainer=Ext.get(me.body.child(".form .auto-signin"));var btnsigninContainer=Ext.get(me.body.child(".form .btn-signin"));me.forms.userid=new Ext.form.TextField({tabIndex:1,allowBlank:false,disabled:true,enableKeyEvents:true,validationEvent:false,validator:function(v){if(v=="")return Trick.SigninDialog.msg.signin.validate.email;return true},listeners:{keypress:{fn:function(field,
e){if(e.getKey()===e.ENTER)me.signin()},scope:me}},renderTo:useridContainer});me.forms.password=new Ext.form.TextField({inputType:"password",tabIndex:2,disabled:true,enableKeyEvents:true,listeners:{keypress:{fn:function(field,e){if(e.getKey()===e.ENTER)me.signin()},scope:me}},renderTo:passwdContainer});me.forms.autosignin=new Ext.form.Checkbox({disabled:true,boxLabel:Trick.SigninDialog.msg.signin.labels.autosignin,tabIndex:3,listeners:{afterrender:function(c){c.el.on("keypress",function(e,t){if(e.getKey()===
e.ENTER)me.signin()})}},renderTo:autosigninContainer});me.forms.submit=new Ext.Button({text:Trick.SigninDialog.msg.signin.labels.submit,disabled:true,type:"submit",tabIndex:4,handler:me.signin,scope:me,renderTo:btnsigninContainer})},signin:function(){var me=this;var msg=me.bodyItems.child("td.msg span");me.forms.submit.disable();me.title.update(Trick.SigninDialog.msg.signin.progress);me.forget.fadeOut({duration:me.duration});msg.fadeOut({duration:me.duration,callback:function(){me.fireEvent("auth",
{directFn:me.directFn,userid:me.forms.userid.getValue(),passwd:me.forms.password.getValue(),autoSignin:me.forms.autosignin.getValue()})}})},success:function(o){var me=this;me.hide()},failure:function(o){var me=this;var msg=me.bodyItems.child("td.msg span");me.title.update(Trick.SigninDialog.msg.signin.title);msg.update(o.msg);me.forget.fadeIn({duration:me.duration});me.forms.submit.enable();msg.setOpacity(0);msg.setStyle({display:"block"});msg.fadeIn({callback:function(){me.forms.userid.selectText();
me.fireEvent("failure")}})},hide:function(o){var me=this,cp=me.getCenterPosition();me.title.fadeOut({duration:me.duration});me.forget.fadeOut({duration:me.duration});me.bodyItems.fadeOut({duration:me.duration,callback:function(){me.layer.shift({x:cp.x-me.distance,easing:"easeOutStrong",opacity:0,duration:me.duration,callback:function(){me.layer.remove();me.fireEvent("hide",{},me)}})}})},show:function(){var me=this,cp=me.getCenterPosition();me.layer.setLeft(cp.x+me.distance);me.layer.setTop(cp.y);
me.layer.setOpacity(0);me.layer.show();me.body.setOpacity(0.5);me.bodyItems.setOpacity(0);me.layer.shift({x:cp.x,easing:"easeOutStrong",opacity:1,duration:me.duration,callback:function(){me.body.setOpacity(1);me.title.fadeIn({duration:me.duration});me.forget.fadeIn({duration:me.duration});me.bodyItems.fadeIn({duration:me.duration,callback:function(){me.forms.userid.enable();me.forms.password.enable();me.forms.autosignin.enable();me.forms.submit.enable();me.forms.userid.focus();me.fireEvent("show",
me)}})}})},getCenterPosition:function(){var me=this,vs=Ext.getDoc().getViewSize();return{x:(vs.width-me.layer.getWidth())/2,y:(vs.height-me.layer.getHeight())/2}},onWindowResize:function(w,h){var me=this,vs=Ext.getDoc().getViewSize(),cwp=(vs.width-me.layer.getWidth())/2,chp=(vs.height-me.layer.getHeight())/2;if(me.isVisible){me.layer.setLeft(cwp);me.layer.setTop(chp)}}});
Trick.SigninDialog.msg={signin:{title:"OmegaTrick\u306b\u30b5\u30a4\u30f3\u30a4\u30f3",progress:"\u30b5\u30a4\u30f3\u30a4\u30f3\u4e2d...",labels:{userid:"\u30e6\u30fc\u30b6\u30fcID",password:"\u30d1\u30b9\u30ef\u30fc\u30c9",autosignin:"1 \u9031\u9593\u30b5\u30a4\u30f3\u30a4\u30f3\u3057\u7d9a\u3051\u308b",submit:"\u30b5\u30a4\u30f3\u30a4\u30f3"},validate:{email:"\u30e6\u30fc\u30b6ID\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002"},forget:{text:"\u30d1\u30b9\u30ef\u30fc\u30c9\u7d1b\u5931",
url:"forget.html"}}};Trick.grid.Column=Ext.extend(Ext.grid.Column,{constructor:function(cfg){var me=this;Ext.iterate(cfg,function(name){if(me[name])cfg[name]=me[name]});Trick.grid.Column.superclass.constructor.call(me,cfg)}});Trick.form.FormPanel=Ext.extend(Ext.form.FormPanel,{plugins:["t.xitems","t.xforms","t.CompositeFieldFix"],initComponent:function(){var me=this;me.setDeepDefault(me.initialConfig.items);Trick.form.FormPanel.superclass.initComponent.apply(me,arguments)},setDeepDefault:function(items){var me=this;Ext.each(items,function(item,cnt,items){Ext.applyIf(item,me.xdefault);if(item&&item.items&&item.items.length>0)me.setDeepDefault(item.items)})}});Trick.FormPanel=Trick.form.FormPanel;Trick.grid.GridPanel=Ext.extend(Ext.grid.GridPanel,{plugins:["t.xcolumns"],initComponent:function(){var me=this;Trick.grid.GridPanel.superclass.initComponent.apply(me,arguments)}});Trick.GridPanel=Trick.grid.GridPanel;Trick.plugins.xitems=function(){var me=this;me.init=function(cmp){me.deep(cmp)};me.deep=function(cmp){Ext.each(cmp.xitems,function(item){cmp.add({xtype:item})});if(cmp.items&&cmp.items.each)cmp.items.each(function(item){me.deep(item)})}};Ext.preg("t.xitems",Trick.plugins.xitems);Trick.plugins.xforms=function(){var me=this;me.init=function(cmp){cmp.initXForms=true;cmp.on("afterrender",me.onAfterRender,cmp)};me.onAfterRender=function(){var cmp=this;cmp.xforms={};me.scanFormItems(cmp.items,cmp)};me.scanFormItems=function(items,cmp){items.each(function(item,index,length){if(item.items&&item.items.getCount()>0)me.scanFormItems(item.items,cmp);if(item.xname)cmp.xforms[item.xname]=item})}};Ext.preg("t.xforms",Trick.plugins.xforms);Trick.plugins.xcolumns=function(){var me=this;me.init=function(cmp){var model=cmp.colModel;var config=model.config;if(Ext.isObject(config)){Ext.each(config.xcolumns,function(name,cnt){config.xcolumns[cnt]={xtype:name}});model.setConfig(config.xcolumns,true)}}};Ext.preg("t.xcolumns",Trick.plugins.xcolumns);Trick.plugins.xbuttons=function(){var me=this;me.init=function(cmp){if(cmp.xbuttons){var buttons=[];Ext.each(cmp.xbuttons,function(item){buttons.push({xtype:item})});cmp.fbar=buttons;cmp.createFbar(cmp.fbar);cmp.xbuttons={};Ext.each(cmp.buttons,function(item){if(item.xname)cmp.xbuttons[item.xname]=item})}}};Ext.preg("t.xbuttons",Trick.plugins.xbuttons);Trick.plugins.CompositeFieldFix=function(){var me=this;me.init=function(cmp){if(Ext.isIE6)cmp.on("afterrender",function(){cmp.hide();cmp.show()})}};Ext.preg("t.CompositeFieldFix",Trick.plugins.CompositeFieldFix);
